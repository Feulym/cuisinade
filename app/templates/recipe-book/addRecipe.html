{% extends 'base.html' %}

{% block title %} {{ recipe.title if recipe else 'Nouvelle recette' }} {% endblock %}

{% block styles %}
<style>
/* Star Rating System - Mobile Optimized */
.rating {
    margin-top: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    border: none;
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    width: fit-content;
    gap: var(--spacing-xs);
}

.rating > label {
    color: var(--gray-400);
    cursor: pointer;
    min-width: var(--touch-target-min);
    min-height: var(--touch-target-min);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
}

.rating > label:before {
    font-size: 2em;
    font-family: FontAwesome;
    content: "\f005";
    display: inline-block;
}

.rating > input {
    display: none;
}

.rating > input:checked ~ label,
.rating > label:hover,
.rating > label:hover ~ label {
    color: #F79426;
}

.rating > label:active {
    transform: scale(1.2);
}

@media (hover: hover) and (pointer: fine) {
    .rating > input:checked + label:hover,
    .rating > input:checked ~ label:hover,
    .rating > label:hover ~ input:checked ~ label,
    .rating > input:checked ~ label:hover ~ label {
        color: #FECE31;
    }
}

/* Dynamic List Items */
.ingredient-item,
.instruction-item {
    background: var(--gray-50);
    padding: var(--spacing-md);
    border-radius: var(--radius-sm);
    margin-bottom: var(--spacing-md);
    border-left: 4px solid var(--primary-color);
    position: relative;
}

.ingredient-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: var(--spacing-sm);
    align-items: start;
}

@media (max-width: 768px) {
    .ingredient-item {
        grid-template-columns: 1fr;
    }
}

.instruction-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: var(--spacing-md);
    align-items: start;
}

.step-number {
    background: var(--gradient-primary);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.remove-btn {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-base);
    min-height: var(--touch-target-min);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.remove-btn:active {
    transform: scale(0.96);
}

@media (hover: hover) and (pointer: fine) {
    .remove-btn:hover {
        background: #c82333;
    }
}

.add-more-btn {
    background: var(--success);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    min-height: var(--touch-target-min);
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 600;
    width: 100%;
    justify-content: center;
    margin-bottom: var(--spacing-md);
}

.add-more-btn:active {
    transform: scale(0.98);
}

@media (hover: hover) and (pointer: fine) {
    .add-more-btn:hover {
        background: #218838;
    }
}

/* Autocomplete Dropdown */
.autocomplete-container {
    position: relative;
    width: 100%;
}

.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--primary-color);
    border-top: none;
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    box-shadow: var(--shadow-md);
    display: none;
}

.autocomplete-list.active {
    display: block;
}

.autocomplete-item {
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background var(--transition-fast);
    border-bottom: 1px solid var(--gray-200);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:active,
.autocomplete-item.selected {
    background: var(--primary-color);
    color: white;
}

@media (hover: hover) and (pointer: fine) {
    .autocomplete-item:hover {
        background: var(--gray-100);
    }
    
    .autocomplete-item.selected:hover {
        background: var(--primary-dark);
    }
}

.autocomplete-item.create-new {
    font-weight: 600;
    color: var(--success);
}

/* Input groups */
.input-group-small {
    width: 100px;
}

@media (max-width: 768px) {
    .input-group-small {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block header %}
    <div class="header">
        <h1>{{ 'Modifier la Recette' if recipe else 'Nouvelle Recette !' }}</h1>
        <p class="header-subtitle">{{ recipe.title if recipe else 'Ajoutez votre recette favorite' }}</p>
    </div>
{% endblock %}

{% block content %}
    <div style="max-width: 900px; margin: var(--spacing-xl) auto;">
        <div class="card">
            <div class="card-body">
                <form method="post" id="recipeForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title" class="form-label">
                            <i class="fa fa-pencil"></i> Nom de la recette
                        </label>
                        <input type="text" name="title" id="title" class="form-control" placeholder="Ex: Tarte aux pommes" value="{{ recipe.title if recipe else '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description" class="form-label">
                            <i class="fa fa-align-left"></i> Description
                        </label>
                        <textarea name="description" id="description" rows="4" class="form-control" placeholder="Décrivez votre recette..." required>{{ recipe.description if recipe else '' }}</textarea>
                    </div>

                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="prepTime" class="form-label">
                                <i class="fa fa-clock-o"></i> Temps de préparation (min)
                            </label>
                            <input type="number" name="prepTime" id="prepTime" class="form-control" placeholder="0" min="0" value="{{ recipe.prepTime if recipe else 0 }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="cookTime" class="form-label">
                                <i class="fa fa-fire"></i> Temps de cuisson (min)
                            </label>
                            <input type="number" name="cookTime" id="cookTime" class="form-control" placeholder="0" min="0" value="{{ recipe.cookTime if recipe else 0 }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="servings" class="form-label">
                                <i class="fa fa-users"></i> Nombre de personne
                            </label>
                            <input type="number" name="servings" id="servings" class="form-control" placeholder="0" min="1" value="{{ recipe.servings if recipe else 1 }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="difficulty" class="form-label">
                            <i class="fa fa-signal"></i> Difficulté
                        </label>
                        <select name="difficulty" id="difficulty" class="form-control">
                            <option value="1" {{ 'selected' if recipe and recipe.difficulty == 1 }}>Facile</option>
                            <option value="2" {{ 'selected' if recipe and recipe.difficulty == 2 }}>Moyenne</option>
                            <option value="3" {{ 'selected' if recipe and recipe.difficulty == 3 }}>Difficile</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fa fa-star"></i> Note
                        </label>
                        <div class="rating">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="star{{i}}" name="rating" value="{{i}}" 
                                   {{ 'checked' if recipe and recipe.author_grade == i }} 
                                   {{ 'required' if i == 5 }} />
                            <label class="star" for="star{{i}}" title="Rating {{i}}" aria-label="{{i}} étoiles"></label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- NOUVEAU : Upload d'image -->
                    <div class="form-group">
                        <label for="recipe_image" class="form-label">
                            <i class="fa fa-camera"></i> Photo de la recette
                        </label>
                        
                        {% if recipe and recipe.image_url %}
                        <div class="current-image-preview" style="margin-bottom: var(--spacing-md);">
                            <img src="{{ recipe.image_url }}" alt="Photo actuelle" style="max-width: 300px; border-radius: var(--radius-md);">
                            <div style="margin-top: var(--spacing-sm);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
                                    <input type="checkbox" name="remove_image" value="true">
                                    Supprimer cette image
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        
                        <input 
                            type="file" 
                            name="recipe_image" 
                            id="recipe_image" 
                            class="form-control" 
                            accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                            onchange="previewImage(event, 'imagePreview')"
                        >
                        <small class="form-text">
                            Formats acceptés : PNG, JPG, GIF, WEBP (max 5MB)
                        </small>
                        
                        <!-- Prévisualisation -->
                        <div id="imagePreview" style="margin-top: var(--spacing-md); display: none;">
                            <p style="font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                                Prévisualisation :
                            </p>
                            <img id="previewImg" src="" alt="Prévisualisation" style="max-width: 300px; border-radius: var(--radius-md); box-shadow: var(--shadow-md);">
                        </div>
                    </div>

                    <div class="section">
                        <h2 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                            <i class="fa fa-shopping-basket"></i> Ingredients
                        </h2>
                        
                        <div id="ingredientsList"></div>
                        
                        <button type="button" class="add-more-btn" id="addIngredientBtn">
                            <i class="fa fa-plus"></i> Ajouter un Ingredient
                        </button>
                    </div>

                    <div class="section">
                        <h2 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                            <i class="fa fa-list-ol"></i> Instructions
                        </h2>
                        
                        <div id="instructionsList"></div>
                        
                        <button type="button" class="add-more-btn" id="addInstructionBtn">
                            <i class="fa fa-plus"></i> Ajouter une étape
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes" class="form-label">
                            <i class="fa fa-align-left"></i> Note du Chef
                        </label>
                        <textarea name="notes" id="notes" rows="4" class="form-control" placeholder="Avez-vous un secret Chef ?">{{ recipe.notes if recipe else '' }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" style="margin-top: var(--spacing-xl);">
                        <i class="fa fa-save"></i> {{ 'Mettre à jour la recette' if recipe else 'Ajouter la recette' }}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let existingIngredients = [];
        const units = ['g', 'kg', 'ml', 'L', 'cuillères à soupe', 'cuillères à café', 'pièce(s)', 'tasse(s)', 'pincée(s)'];
        let ingredientCount = 0;
        let instructionCount = 0;

        // Fetch ingredients from database on page load
        async function loadIngredients() {
            try {
                const response = await fetch("{{ url_for('recipeBook.get_ingredients') }}");
                if (!response.ok) {
                    throw new Error('Erreur dans la récupération des ingrédients');
                }
                const data = await response.json();
                existingIngredients = data;
                console.log('Loaded ingredients:', existingIngredients.length);
            } catch (error) {
                console.error('Error loading ingredients:', error);
                existingIngredients = [];
                alert('Erreur lors du chargement des ingrédients.');
            }
        }

        // Initialize page
        async function initializePage() {
            await loadIngredients();
            
            // Check for edit mode data from Flask
            const hasExistingData = {{ 'true' if ingredients or instructions else 'false' }};
            
            if (hasExistingData) {
                // Populate existing ingredients
                {% if ingredients %}
                    {% for ing in ingredients %}
                    addIngredient({
                        name: "{{ ing.name|e }}",
                        id: "{{ ing.ingredient_id }}",
                        quantity: "{{ ing.quantity }}",
                        unit: "{{ ing.unit }}"
                    });
                    {% endfor %}
                {% endif %}

                // Populate existing instructions
                {% if instructions %}
                    {% for inst in instructions %}
                    addInstruction("{{ inst.instruction|replace('\n', '\\n')|replace('\r', '')|e }}");
                    {% endfor %}
                {% endif %}
            } else {
                // Default blank rows for new recipe
                addIngredient();
                addInstruction();
            }
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', initializePage);

        // Ingredient Management
        function addIngredient(data = null) {
            ingredientCount++;
            const id = `ingredient-${ingredientCount}`;
            
            const ingredientHtml = `
                <div class="ingredient-item" id="${id}">
                    <div class="autocomplete-container">
                        <input 
                            type="text" 
                            class="form-control ingredient-name" 
                            placeholder="Nom de l'ingrédient"
                            data-ingredient-id="${data ? data.id : ''}"
                            value="${data ? data.name : ''}"
                            required
                        >
                        <div class="autocomplete-list"></div>
                    </div>
                    
                    <input 
                        type="number" 
                        class="form-control input-group-small ingredient-quantity" 
                        placeholder="Qté" 
                        min="0"
                        step="0.01"
                        value="${data ? data.quantity : ''}"
                        required
                    >
                    
                    <select class="form-control ingredient-unit" required>
                        <option value="">Unité</option>
                        ${units.map(unit => `
                            <option value="${unit}" ${data && data.unit === unit ? 'selected' : ''}>
                                ${unit}
                            </option>`).join('')}
                    </select>
                    
                    <button type="button" class="remove-btn" onclick="removeIngredient('${id}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('ingredientsList').insertAdjacentHTML('beforeend', ingredientHtml);
            setupAutocomplete(document.querySelector(`#${id} .ingredient-name`));
        }

        function removeIngredient(id) {
            document.getElementById(id).remove();
        }

        // Autocomplete functionality
        function setupAutocomplete(input) {
            const dropdown = input.nextElementSibling;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (value.length < 1) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                const matches = existingIngredients.filter(ing => 
                    ing.name.toLowerCase().includes(value)
                );
                
                matches.forEach(ing => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = ing.name;
                    item.dataset.id = ing.id;
                    item.addEventListener('click', () => selectIngredient(input, ing));
                    dropdown.appendChild(item);
                });
                
                if (value && !matches.some(ing => ing.name.toLowerCase() === value)) {
                    const createItem = document.createElement('div');
                    createItem.className = 'autocomplete-item create-new';
                    createItem.innerHTML = `<i class="fa fa-plus"></i> Créer "${value}"`;
                    createItem.addEventListener('click', () => createNewIngredient(input, value));
                    dropdown.appendChild(createItem);
                }
                
                dropdown.classList.add('active');
            });
            
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        function selectIngredient(input, ingredient) {
            input.value = ingredient.name;
            input.dataset.ingredientId = ingredient.id;
            input.nextElementSibling.classList.remove('active');
        }

        function createNewIngredient(input, name) {
            if (!name || name.trim().length === 0) return;
            
            fetch("{{ url_for('recipeBook.create_ingredient') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name.trim() })
            })
            .then(response => response.json())
            .then(data => {
                const newIngredient = { id: data.id, name: data.name };
                existingIngredients.push(newIngredient);
                selectIngredient(input, newIngredient);
            });
        }

        // Instruction Management
        function addInstruction(text = "") {
            instructionCount++;
            const id = `instruction-${instructionCount}`;
            
            const instructionHtml = `
                <div class="instruction-item" id="${id}">
                    <div class="step-number">${instructionCount}</div>
                    <textarea 
                        class="form-control instruction-text" 
                        rows="3" 
                        placeholder="Décrivez l'étape..."
                        required
                    >${text}</textarea>
                    <button type="button" class="remove-btn" onclick="removeInstruction('${id}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('instructionsList').insertAdjacentHTML('beforeend', instructionHtml);
            updateInstructionNumbers();
        }

        function removeInstruction(id) {
            document.getElementById(id).remove();
            updateInstructionNumbers();
        }

        function updateInstructionNumbers() {
            const instructions = document.querySelectorAll('.instruction-item');
            instructions.forEach((item, index) => {
                const stepNumber = item.querySelector('.step-number');
                if (stepNumber) {
                    stepNumber.textContent = index + 1;
                }
            });
        }

        // Form Submission
        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            
            // Add ingredients as hidden fields
            document.querySelectorAll('.ingredient-item').forEach((item, idx) => {
                const name = item.querySelector('.ingredient-name').value.trim();
                const id = item.querySelector('.ingredient-name').dataset.ingredientId;
                const qty = item.querySelector('.ingredient-quantity').value;
                const unit = item.querySelector('.ingredient-unit').value;

                if (name && qty && unit) {
                    [['name', name], ['ingredientId', id], ['quantity', qty], ['unit', unit]].forEach(pair => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = `ingredients[${idx}][${pair[0]}]`;
                        input.value = pair[1] || '';
                        form.appendChild(input);
                    });
                }
            });
            
            // Add instructions as hidden fields
            document.querySelectorAll('.instruction-item').forEach((item, idx) => {
                const text = item.querySelector('.instruction-text').value.trim();
                if (text) {
                    const textInput = document.createElement('input');
                    textInput.type = 'hidden';
                    textInput.name = `instructions[${idx}][text]`;
                    textInput.value = text;
                    form.appendChild(textInput);
                    
                    const stepInput = document.createElement('input');
                    stepInput.type = 'hidden';
                    stepInput.name = `instructions[${idx}][step]`;
                    stepInput.value = idx + 1;
                    form.appendChild(stepInput);
                }
            });
            
            form.submit();
        });

        document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredient());
        document.getElementById('addInstructionBtn').addEventListener('click', () => addInstruction());
    


        // Prévisualisation d'image
        function previewImage(event, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const previewImg = document.getElementById('previewImg');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }
    
    </script>
{% endblock %}