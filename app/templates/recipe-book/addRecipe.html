{% extends 'base.html' %}

{% block title %} {{ recipe.title if recipe else 'Nouvelle recette' }} {% endblock %}

{% block styles %}
<style>
/* ... (Gardez vos styles CSS actuels, ils sont parfaits) ... */
.rating {
    margin-top: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);
    border: none;
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    width: fit-content;
    gap: var(--spacing-xs);
}

.rating > label {
    color: var(--gray-400);
    cursor: pointer;
    min-width: var(--touch-target-min);
    min-height: var(--touch-target-min);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
}

.rating > label:before {
    font-size: 2em;
    font-family: FontAwesome;
    content: "\f005";
    display: inline-block;
}

.rating > input {
    display: none;
}

.rating > input:checked ~ label,
.rating > label:hover,
.rating > label:hover ~ label {
    color: #F79426;
}

.rating > label:active {
    transform: scale(1.2);
}

@media (hover: hover) and (pointer: fine) {
    .rating > input:checked + label:hover,
    .rating > input:checked ~ label:hover,
    .rating > label:hover ~ input:checked ~ label,
    .rating > input:checked ~ label:hover ~ label {
        color: #FECE31;
    }
}

/* Dynamic List Items */
.ingredient-item,
.instruction-item {
    background: var(--gray-50);
    padding: var(--spacing-md);
    border-radius: var(--radius-sm);
    margin-bottom: var(--spacing-md);
    border-left: 4px solid var(--primary-color);
    position: relative;
}

.ingredient-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: var(--spacing-sm);
    align-items: start;
    overflow: visible;
}

@media (max-width: 768px) {
    .ingredient-item {
        grid-template-columns: 1fr;
    }
}

.instruction-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: var(--spacing-md);
    align-items: start;
}

.step-number {
    background: var(--gradient-primary);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.remove-btn {
    background: var(--danger);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-base);
    min-height: var(--touch-target-min);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.remove-btn:active {
    transform: scale(0.96);
}

@media (hover: hover) and (pointer: fine) {
    .remove-btn:hover {
        background: #c82333;
    }
}

.add-more-btn {
    background: var(--success);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    padding: var(--spacing-md) var(--spacing-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    min-height: var(--touch-target-min);
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 600;
    width: 100%;
    justify-content: center;
    margin-bottom: var(--spacing-md);
}

.add-more-btn:active {
    transform: scale(0.98);
}

@media (hover: hover) and (pointer: fine) {
    .add-more-btn:hover {
        background: #218838;
    }
}

/* Autocomplete Dropdown */
.autocomplete-container {
    position: relative;
    width: 100%;
    overflow: visible;
}

.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--primary-color);
    border-top: none;
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    box-shadow: var(--shadow-md);
    display: none;
}

.autocomplete-list.active {
    display: block;
}

.autocomplete-item {
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background var(--transition-fast);
    border-bottom: 1px solid var(--gray-200);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:active,
.autocomplete-item.selected {
    background: var(--primary-color);
    color: white;
}

@media (hover: hover) and (pointer: fine) {
    .autocomplete-item:hover {
        background: var(--gray-100);
    }
    
    .autocomplete-item.selected:hover {
        background: var(--primary-dark);
    }
}

.autocomplete-item.create-new {
    font-weight: 600;
    color: var(--success);
}

/* Input groups */
.input-group-small {
    width: 100px;
}

@media (max-width: 768px) {
    .input-group-small {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block header %}
    <div class="header">
        <h1>{{ 'Modifier la Recette' if is_edit else 'Nouvelle Recette !' }}</h1>
        <p class="header-subtitle">{{ recipe.title if recipe else 'Ajoutez votre recette favorite' }}</p>
    </div>
{% endblock %}

{% block content %}
    <div style="max-width: 900px; margin: var(--spacing-xl) auto;">
        <div class="card">
            <div class="card-body">
                <form method="post" id="recipeForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title" class="form-label">
                            <i class="fa fa-pencil"></i> Nom de la recette
                        </label>
                        <input type="text" name="title" id="title" class="form-control" placeholder="Ex: Tarte aux pommes" 
                               value="{{ recipe.title if recipe else '' }}" required>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">
                            <i class="fa fa-align-left"></i> Description
                        </label>
                        <textarea name="description" id="description" rows="4" class="form-control" placeholder="Décrivez votre recette..." required>{{ recipe.description if recipe else '' }}</textarea>
                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="category" class="form-label">
                                <i class="fa fa-book"></i> Type de recette
                            </label>
                            <select name="category" id="category" class="form-control">
                                <option value="-1" {{ 'selected' if recipe and recipe.category|int == -1 else '' }}>Non-spéficié</option>
                                <option value="0" {{ 'selected' if recipe and recipe.category|int == 0 else '' }}>Apéro</option>
                                <option value="1" {{ 'selected' if recipe and recipe.category|int == 1 else '' }}>Entrée</option>
                                <option value="2" {{ 'selected' if recipe and recipe.category|int == 2 else '' }}>Plat principal</option>
                                <option value="3" {{ 'selected' if recipe and recipe.category|int == 3 else '' }}>Dessert</option>
                                <option value="4" {{ 'selected' if recipe and recipe.category|int == 4 else '' }}>Cocktail</option>
                                <option value="5" {{ 'selected' if recipe and recipe.category|int == 5 else '' }}>Autre</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="difficulty" class="form-label">
                                <i class="fa fa-signal"></i> Difficulté
                            </label>
                            <select name="difficulty" id="difficulty" class="form-control">
                                <option value="1" {{ 'selected' if recipe and recipe.difficulty|int == 1 }}>Facile</option>
                                <option value="2" {{ 'selected' if recipe and recipe.difficulty|int == 2 }}>Moyenne</option>
                                <option value="3" {{ 'selected' if recipe and recipe.difficulty|int == 3 }}>Difficile</option>
                            </select>
                        </div>  
                    </div>

                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="prepTime" class="form-label">
                                <i class="fa fa-clock-o"></i> Temps de préparation (min)
                            </label>
                            <input type="number" name="prepTime" id="prepTime" class="form-control" value="{{ recipe.prepTime if recipe else 0 }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="cookTime" class="form-label">
                                <i class="fa fa-fire"></i> Temps de cuisson (min)
                            </label>
                            <input type="number" name="cookTime" id="cookTime" class="form-control" value="{{ recipe.cookTime if recipe else 0 }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="servings" class="form-label">
                                <i class="fa fa-users"></i> Personnes
                            </label>
                            <input type="number" name="servings" id="servings" class="form-control" value="{{ recipe.servings if recipe else 1 }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"><i class="fa fa-star"></i> Note</label>
                        <div class="rating">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="star{{i}}" name="rating" value="{{i}}" 
                                   {{ 'checked' if (recipe.author_grade|int if is_edit else recipe.rating|int) == i }} required />
                            <label class="star" for="star{{i}}"></label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recipe_image" class="form-label"><i class="fa fa-camera"></i> Photo</label>
                        {% if is_edit and recipe.image_url %}
                        <div class="current-image-preview">
                            <img src="{{ recipe.image_url }}" alt="Photo" style="max-width: 200px; display: block; margin-bottom: 10px;">
                            <label><input type="checkbox" name="remove_image" value="true"> Supprimer l'image</label>
                        </div>
                        {% endif %}
                        <input type="file" name="recipe_image" id="recipe_image" class="form-control" onchange="previewImage(event, 'imagePreview')">
                        <div id="imagePreview" style="display: none; margin-top: 10px;">
                            <img id="previewImg" src="" style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>

                    <div class="section">
                        <h2 style="color: var(--primary-color);"><i class="fa fa-shopping-basket"></i> Ingrédients</h2>
                        <div id="ingredientsList"></div>
                        <button type="button" class="add-more-btn" id="addIngredientBtn"><i class="fa fa-plus"></i> Ajouter</button>
                    </div>

                    <div class="section">
                        <h2 style="color: var(--primary-color);"><i class="fa fa-list-ol"></i> Instructions</h2>
                        <div id="instructionsList"></div>
                        <button type="button" class="add-more-btn" id="addInstructionBtn"><i class="fa fa-plus"></i> Ajouter</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes" class="form-label"><i class="fa fa-align-left"></i> Note du Chef</label>
                        <textarea name="notes" id="notes" rows="3" class="form-control">{{ recipe.notes if recipe else '' }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fa fa-save"></i> {{ 'Mettre à jour' if is_edit else 'Ajouter' }}
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let existingIngredients = [];
        const units = ['g', 'kg', 'ml', 'L', 'cuillères à soupe', 'cuillères à café', 'pièce(s)', 'tasse(s)', 'pincée(s)'];
        let ingredientCount = 0;
        let instructionCount = 0;
        
        // Data passed from server
        const initialIngredients = {{ ingredients|tojson if ingredients else '[]' }};
        const initialInstructions = {{ instructions|tojson if instructions else '[]' }};

        async function initializePage() {
            // Chargement des ingrédients pour l'autocomplétion
            try {
                const response = await fetch("{{ url_for('recipeBook.get_ingredients') }}");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                existingIngredients = await response.json();
                console.log(`Loaded ${existingIngredients.length} ingredients`);
            } catch (e) { 
                console.error('Failed to load ingredients:', e);
                existingIngredients = [];
            }

            // Remplissage des données existantes (en cas d'edit OU d'erreur de formulaire)
            if (initialIngredients.length > 0) {
                initialIngredients.forEach(ing => {
                    addIngredient({
                        name: ing.name,
                        id: ing.ingredient_id || '',
                        quantity: ing.quantity,
                        unit: ing.unit
                    });
                });
            } else {
                addIngredient();
            }

            if (initialInstructions.length > 0) {
                initialInstructions.forEach(inst => {
                    addInstruction(inst.instruction);
                });
            } else {
                addInstruction();
            }
        }

        document.addEventListener('DOMContentLoaded', initializePage);

        function addIngredient(data = null) {
            ingredientCount++;
            const id = `ingredient-${ingredientCount}`;
            const html = `
                <div class="ingredient-item" id="${id}">
                    <div class="autocomplete-container">
                        <input type="text" class="form-control ingredient-name" placeholder="Nom" 
                               data-ingredient-id="${data ? data.id : ''}" value="${data ? data.name : ''}" required>
                        <div class="autocomplete-list"></div>
                    </div>
                    <input type="number" class="form-control ingredient-quantity" placeholder="Qté" step="0.01" value="${data ? data.quantity : ''}" required>
                    <select class="form-control ingredient-unit" required>
                        <option value="">Unité</option>
                        ${units.map(u => `<option value="${u}" ${data && data.unit === u ? 'selected' : ''}>${u}</option>`).join('')}
                    </select>
                    <button type="button" class="remove-btn" onclick="removeIngredient('${id}')"><i class="fa fa-trash"></i></button>
                </div>`;
            document.getElementById('ingredientsList').insertAdjacentHTML('beforeend', html);
            setupAutocomplete(document.querySelector(`#${id} .ingredient-name`));
        }

        function addInstruction(text = "") {
            instructionCount++;
            const id = `instruction-${instructionCount}`;
            const html = `
                <div class="instruction-item" id="${id}">
                    <div class="step-number">${instructionCount}</div>
                    <textarea class="form-control instruction-text" rows="2" placeholder="Étape..." required>${text}</textarea>
                    <button type="button" class="remove-btn" onclick="removeInstruction('${id}')"><i class="fa fa-trash"></i></button>
                </div>`;
            document.getElementById('instructionsList').insertAdjacentHTML('beforeend', html);
            updateInstructionNumbers();
        }

        function removeIngredient(id) { document.getElementById(id).remove(); }
        function removeInstruction(id) { 
            document.getElementById(id).remove(); 
            updateInstructionNumbers();
        }

        function updateInstructionNumbers() {
            document.querySelectorAll('.instruction-item').forEach((item, index) => {
                item.querySelector('.step-number').textContent = index + 1;
            });
        }

        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            const form = this;
            console.log('Form submitted');
            
            // Check for empty ingredients
            const ingredientItems = document.querySelectorAll('.ingredient-item');
            let hasInvalidIngredient = false;
            
            ingredientItems.forEach((item, idx) => {
                const name = item.querySelector('.ingredient-name').value.trim();
                const qty = item.querySelector('.ingredient-quantity').value.trim();
                const unit = item.querySelector('.ingredient-unit').value.trim();
                
                console.log(`Ingredient ${idx}:`, {name, qty, unit});
                
                if ((name && !qty) || (name && !unit) || (!name && qty) || (!name && unit)) {
                    hasInvalidIngredient = true;
                }

                const createHidden = (n, v) => {
                    const i = document.createElement('input');
                    i.type = 'hidden'; i.name = `ingredients[${idx}][${n}]`; i.value = v;
                    form.appendChild(i);
                };
                createHidden('name', name);
                createHidden('ingredientId', item.querySelector('.ingredient-name').dataset.ingredientId || '');
                createHidden('quantity', qty);
                createHidden('unit', unit);
            });

            document.querySelectorAll('.instruction-item').forEach((item, idx) => {
                const text = item.querySelector('.instruction-text').value;
                const createHidden = (n, v) => {
                    const i = document.createElement('input');
                    i.type = 'hidden'; i.name = `instructions[${idx}][${n}]`; i.value = v;
                    form.appendChild(i);
                };
                createHidden('text', text);
                createHidden('step', idx + 1);
            });
        });

        function previewImage(event, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const previewImg = document.getElementById('previewImg');
            if (file) {
                const reader = new FileReader();
                reader.onload = e => { previewImg.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }

        function setupAutocomplete(input) {
            const dropdown = input.nextElementSibling;
            
            function updateDropdown() {
                const val = input.value.toLowerCase().trim();
                dropdown.innerHTML = '';
                
                if (val.length === 0) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                const matches = existingIngredients.filter(ing => 
                    ing.name.toLowerCase().includes(val)
                );
                
                if (matches.length === 0) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                matches.forEach(ing => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = ing.name;
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        input.value = ing.name;
                        input.dataset.ingredientId = ing.id;
                        dropdown.classList.remove('active');
                    });
                    dropdown.appendChild(item);
                });
                
                dropdown.classList.add('active');
            }
            
            input.addEventListener('input', updateDropdown);
            input.addEventListener('focus', updateDropdown);
            
            input.addEventListener('blur', function() {
                // Small delay to allow click on dropdown item to register
                setTimeout(() => {
                    if (!dropdown.matches(':hover')) {
                        dropdown.classList.remove('active');
                    }
                }, 200);
            });
        }

        document.getElementById('addIngredientBtn').onclick = () => addIngredient();
        document.getElementById('addInstructionBtn').onclick = () => addInstruction();
    </script>
{% endblock %}